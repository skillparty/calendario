<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar10 - Debug Mode</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header-modern">
        <div class="header-container">
            <div class="header-left">
                <div class="brand-section">
                    <img src="public/app.png" alt="Calendar10" class="brand-logo">
                </div>
            </div>
            
            <nav class="header-nav">
                <button id="calendar-btn" class="nav-item">
                    <span class="nav-icon">ðŸ“…</span>
                    <span class="nav-text">Calendario</span>
                </button>
                <button id="agenda-btn" class="nav-item">
                    <span class="nav-icon">ðŸ“‹</span>
                    <span class="nav-text">Agenda</span>
                </button>
            </nav>
            
            <div class="header-right">
                <div id="user-status" class="user-section">
                    <button id="login-btn" class="user-btn">
                        <span id="login-icon" class="user-icon">ðŸ‘¤</span>
                        <span id="login-text" class="user-text">Iniciar SesiÃ³n</span>
                    </button>
                    <div id="user-info" class="user-info hidden">
                        <img id="user-avatar" alt="Avatar" class="user-avatar hidden">
                        <span id="user-name" class="user-name"></span>
                        <button id="logout-btn" class="logout-btn">Salir</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div id="debug-info" style="background: #f0f0f0; padding: 20px; margin: 20px; border-radius: 8px;">
            <h2>Debug Information</h2>
            <div id="debug-output"></div>
            <button onclick="testAuth()" style="margin: 10px; padding: 10px 20px;">Test GitHub Auth</button>
            <button onclick="testBackend()" style="margin: 10px; padding: 10px 20px;">Test Backend</button>
            <button onclick="clearStorage()" style="margin: 10px; padding: 10px 20px;">Clear Storage</button>
        </div>

        <div id="calendar-view" class="view">
            <h1>Calendario</h1>
            <div id="calendar-container">
                <div id="calendar-header">
                    <button id="prev-month">â€¹</button>
                    <h2 id="current-month"></h2>
                    <button id="next-month">â€º</button>
                </div>
                <div id="calendar-grid"></div>
            </div>
        </div>

        <div id="agenda-view" class="view hidden">
            <h1>Agenda</h1>
            <div id="agenda-content"></div>
        </div>
    </main>

    <script>
        // Debug mode - simplified version without modules
        const API_BASE_URL = 'https://calendario-backend-v2.fly.dev';
        const GITHUB_CLIENT_ID = 'Ov23liyk7oqj7OI75MfO';
        const GITHUB_REDIRECT_URI = 'https://skillparty.github.io/calendario/debug.html';
        const GITHUB_AUTH_URL = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&scope=user,gist&redirect_uri=${encodeURIComponent(GITHUB_REDIRECT_URI)}`;

        function log(message) {
            const output = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            console.log(message);
        }

        function testBackend() {
            log('Testing backend connection...');
            fetch(API_BASE_URL + '/api/health')
                .then(res => {
                    log(`Backend health check: ${res.status} ${res.statusText}`);
                    return res.json();
                })
                .then(data => {
                    log(`Backend response: ${JSON.stringify(data)}`);
                })
                .catch(err => {
                    log(`Backend error: ${err.message}`);
                });
        }

        function testAuth() {
            log('Starting GitHub authentication...');
            const stateToken = Math.random().toString(36).slice(2) + Date.now().toString(36);
            localStorage.setItem('oauth_state', stateToken);
            const url = new URL(GITHUB_AUTH_URL);
            url.searchParams.set('state', stateToken);
            window.location.href = url.toString();
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('Storage cleared');
        }

        function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                log(`OAuth error: ${error}`);
                return;
            }

            if (authCode) {
                log(`Received auth code: ${authCode.substring(0, 10)}...`);
                
                const savedState = localStorage.getItem('oauth_state');
                if (state !== savedState) {
                    log('State mismatch - possible CSRF attack');
                    return;
                }

                log('Exchanging code for token...');
                fetch(API_BASE_URL + '/api/auth/github', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        code: authCode,
                        redirect_uri: GITHUB_REDIRECT_URI
                    })
                })
                .then(async (res) => {
                    log(`Auth response status: ${res.status}`);
                    const text = await res.text();
                    log(`Auth response body: ${text}`);
                    
                    if (!res.ok) {
                        throw new Error(`Auth HTTP ${res.status}: ${text}`);
                    }
                    
                    return JSON.parse(text);
                })
                .then(data => {
                    log(`Auth success: ${JSON.stringify(data, null, 2)}`);
                    
                    if (data.success && data.token && data.user) {
                        localStorage.setItem('userSession', JSON.stringify({
                            jwt: data.token,
                            user: data.user,
                            loginTime: Date.now()
                        }));
                        
                        // Update UI
                        document.getElementById('login-btn').style.display = 'none';
                        document.getElementById('user-info').classList.remove('hidden');
                        document.getElementById('user-name').textContent = data.user.name || data.user.username;
                        
                        if (data.user.avatar_url) {
                            const avatar = document.getElementById('user-avatar');
                            avatar.src = data.user.avatar_url;
                            avatar.classList.remove('hidden');
                        }
                        
                        log('Login successful!');
                    }
                })
                .catch(err => {
                    log(`Auth error: ${err.message}`);
                });

                // Clean URL
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Debug mode initialized');
            
            // Check for existing session
            const session = localStorage.getItem('userSession');
            if (session) {
                try {
                    const data = JSON.parse(session);
                    log(`Found existing session for: ${data.user?.name || data.user?.username}`);
                } catch (e) {
                    log('Invalid session data found');
                }
            }
            
            handleOAuthCallback();
            testBackend();
        });

        // Navigation
        document.getElementById('calendar-btn')?.addEventListener('click', () => {
            document.getElementById('calendar-view').classList.remove('hidden');
            document.getElementById('agenda-view').classList.add('hidden');
        });

        document.getElementById('agenda-btn')?.addEventListener('click', () => {
            document.getElementById('agenda-view').classList.remove('hidden');
            document.getElementById('calendar-view').classList.add('hidden');
        });

        document.getElementById('login-btn')?.addEventListener('click', testAuth);
        
        document.getElementById('logout-btn')?.addEventListener('click', () => {
            localStorage.removeItem('userSession');
            document.getElementById('login-btn').style.display = 'block';
            document.getElementById('user-info').classList.add('hidden');
            log('Logged out');
        });
    </script>
</body>
</html>
