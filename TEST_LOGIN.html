<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login GitHub</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-box {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #0070f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0051cc;
        }
        .result {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            overflow-x: auto;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        pre { margin: 5px 0; }
        .step { margin: 15px 0; }
        h3 { color: #0070f3; margin-top: 0; }
    </style>
</head>
<body>
    <h1>üîç Test de Login con GitHub</h1>
    
    <div class="test-box">
        <h3>Configuraci√≥n Actual</h3>
        <div class="result" id="config"></div>
    </div>

    <div class="test-box">
        <h3>Paso 1: Verificar Backend</h3>
        <button onclick="testBackend()">Test Backend Health</button>
        <div class="result" id="backend-result"></div>
    </div>

    <div class="test-box">
        <h3>Paso 2: Verificar Auth Endpoint</h3>
        <button onclick="testAuthEndpoint()">Test Auth Endpoint</button>
        <div class="result" id="auth-result"></div>
    </div>

    <div class="test-box">
        <h3>Paso 3: Iniciar Login con GitHub</h3>
        <button onclick="startGitHubLogin()">Login con GitHub</button>
        <div class="result" id="github-result"></div>
    </div>

    <div class="test-box">
        <h3>Paso 4: Estado del Callback</h3>
        <div class="result" id="callback-result"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://backend-eight-zeta-snldyompdv.vercel.app';
        const GITHUB_CLIENT_ID = 'Ov231iO2tcNCvRBxrHov';
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        // Mostrar configuraci√≥n
        document.getElementById('config').innerHTML = `
            <pre>
API Base URL: <span class="success">${API_BASE_URL}</span>
GitHub Client ID: <span class="success">${GITHUB_CLIENT_ID}</span>
Redirect URI: <span class="success">${REDIRECT_URI}</span>
Current URL: ${window.location.href}
            </pre>
        `;

        async function testBackend() {
            const result = document.getElementById('backend-result');
            result.innerHTML = '<span style="color: #ff0">‚è≥ Probando backend...</span>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `
                        <span class="success">‚úÖ Backend OK</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <span class="error">‚ùå Error: ${response.status}</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        }

        async function testAuthEndpoint() {
            const result = document.getElementById('auth-result');
            result.innerHTML = '<span style="color: #ff0">‚è≥ Probando endpoint de autenticaci√≥n...</span>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/github`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                
                if (response.status === 400 && data.error === 'Code is required') {
                    result.innerHTML = `
                        <span class="success">‚úÖ Endpoint funciona correctamente</span>
                        <pre>Respuesta esperada: ${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <span style="color: #ff0">‚ö†Ô∏è  Respuesta inesperada (${response.status})</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
            }
        }

        function startGitHubLogin() {
            const result = document.getElementById('github-result');
            const authURL = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&scope=user,gist&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
            
            result.innerHTML = `
                <span style="color: #ff0">üîÑ Redirigiendo a GitHub...</span>
                <pre>URL: ${authURL}</pre>
            `;
            
            setTimeout(() => {
                window.location.href = authURL;
            }, 1000);
        }

        // Manejar callback de GitHub
        async function handleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');
            const result = document.getElementById('callback-result');

            if (error) {
                result.innerHTML = `
                    <span class="error">‚ùå Error de GitHub: ${error}</span>
                    <pre>Description: ${params.get('error_description')}</pre>
                `;
                return;
            }

            if (code) {
                result.innerHTML = '<span style="color: #ff0">‚è≥ Intercambiando c√≥digo por token...</span>';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/auth/github`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ code })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        result.innerHTML = `
                            <span class="success">‚úÖ ¬°Login exitoso!</span>
                            <pre>Usuario: ${data.user.username}
Email: ${data.user.email}
Token recibido: S√≠ ‚úì</pre>
                        `;
                    } else {
                        result.innerHTML = `
                            <span class="error">‚ùå Error del backend (${response.status})</span>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `;
                    }
                } catch (error) {
                    result.innerHTML = `
                        <span class="error">‚ùå Error de red: ${error.message}</span>
                    `;
                }
            } else {
                result.innerHTML = '<span style="color: #888">Esperando callback de GitHub...</span>';
            }
        }

        // Ejecutar al cargar
        window.addEventListener('DOMContentLoaded', handleCallback);
    </script>
</body>
</html>
